name: Hotfix Deployment

on:
  push:
    branches: [ hotfix/* ]

jobs:
  hotfix-deploy:
    name: Hotfix Build and Deploy
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Quick build verification
      run: |
        echo "ðŸ”§ Building hotfix..."
        cd backend && dotnet build --configuration Release
        cd ../frontend && npm ci --legacy-peer-deps && npm run build

    - name: Create backup of current deployment
      run: |
        echo "ðŸ“¦ Creating backup before hotfix deployment..."
        timestamp=$(date +%Y%m%d_%H%M%S)
        docker tag golfleaguemanager-backend:latest golfleaguemanager-backend:backup_$timestamp || true
        docker tag golfleaguemanager-frontend:latest golfleaguemanager-frontend:backup_$timestamp || true

    - name: Deploy hotfix
      run: |
        echo "ðŸš€ Deploying hotfix..."
        docker compose down
        docker compose up -d --build
        sleep 30

    - name: Verify hotfix deployment
      run: |
        chmod +x ./verify-deployment.sh
        ./verify-deployment.sh

    - name: Notify hotfix completion
      run: |
        echo "ðŸŽ¯ Hotfix deployed successfully!"
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
