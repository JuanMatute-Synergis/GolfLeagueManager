<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" 
     (click)="onBackdropClick($event)">
  <div class="bg-card border border-border rounded-lg shadow-xl max-w-7xl w-full mx-2 max-h-[95vh] overflow-hidden flex flex-col"
       (click)="$event.stopPropagation()">
    
    <!-- Compact Header -->
    <div class="bg-primary text-primary-foreground p-3 flex justify-between items-center flex-shrink-0">
      <div>
        <h2 class="text-lg font-bold">{{ isViewMode() ? 'Scorecard View' : 'Golf Scorecard' }}</h2>
        <p class="text-xs opacity-90">{{ getFlightName() }} - {{ course.name }}</p>
      </div>
      <button 
        (click)="onClose()"
        class="text-primary-foreground hover:bg-primary/80 rounded-full p-2 transition-colors">
        ✕
      </button>
    </div>

    <!-- Ultra Compact Player Header -->
    <div class="bg-muted/20 border-b border-border p-2 flex-shrink-0">
      <div class="grid grid-cols-2 gap-6">
        <!-- Player A Section - Left Aligned -->
        <div class="flex flex-col items-start">
          <div class="flex items-center gap-2">
            <h3 class="font-medium text-sm text-blue-600">{{ scorecardData.playerAName }}</h3>
            <span class="text-xs text-muted-foreground">HC: {{ scorecardData.playerAHandicap || 0 }}</span>
            <div class="text-xs font-bold text-primary">
              {{ scorecardData.playerAMatchPoints || 0 }}/20
              <span class="text-muted-foreground ml-1">({{ scorecardData.playerAHolePoints || 0 }}{{ scorecardData.playerAMatchWin ? '+2' : '' }})</span>
            </div>
          </div>
          
          <!-- Inline Absence Options - Edit Mode Only -->
          <div *ngIf="isEditMode() && !scorecardData.playerAAbsent" class="flex items-center gap-2 mt-1">
            <label class="flex items-center gap-1 cursor-pointer text-xs">
              <input 
                type="checkbox" 
                [(ngModel)]="scorecardData.playerAAbsent"
                (change)="onPlayerAbsenceChange('A')"
                class="w-3 h-3 text-primary bg-background border-border rounded">
              <span class="text-muted-foreground">Absent</span>
            </label>
          </div>
          <div *ngIf="isEditMode() && scorecardData.playerAAbsent" class="flex items-center gap-3 mt-1 text-xs">
            <label class="flex items-center gap-1 cursor-pointer">
              <input 
                type="checkbox" 
                [(ngModel)]="scorecardData.playerAAbsent"
                (change)="onPlayerAbsenceChange('A')"
                class="w-3 h-3 text-primary bg-background border-border rounded">
              <span class="text-foreground">Absent</span>
            </label>
            <label class="flex items-center gap-1 cursor-pointer">
              <input 
                type="radio" 
                name="playerAAbsenceType"
                [value]="true"
                [(ngModel)]="scorecardData.playerAAbsentWithNotice"
                class="w-3 h-3 text-primary bg-background border-border">
              <span class="text-muted-foreground">Notice (4pts)</span>
            </label>
            <label class="flex items-center gap-1 cursor-pointer">
              <input 
                type="radio" 
                name="playerAAbsenceType"
                [value]="false"
                [(ngModel)]="scorecardData.playerAAbsentWithNotice"
                class="w-3 h-3 text-primary bg-background border-border">
              <span class="text-muted-foreground">No Notice (0pts)</span>
            </label>
          </div>
        </div>
        
        <!-- Player B Section - Right Aligned -->
        <div class="flex flex-col items-end">
          <div class="flex items-center gap-2">
            <div class="text-xs font-bold text-primary">
              {{ scorecardData.playerBMatchPoints || 0 }}/20
              <span class="text-muted-foreground mr-1">({{ scorecardData.playerBHolePoints || 0 }}{{ scorecardData.playerBMatchWin ? '+2' : '' }})</span>
            </div>
            <span class="text-xs text-muted-foreground">HC: {{ scorecardData.playerBHandicap || 0 }}</span>
            <h3 class="font-medium text-sm text-red-600">{{ scorecardData.playerBName }}</h3>
          </div>
          
          <!-- Inline Absence Options - Edit Mode Only -->
          <div *ngIf="isEditMode() && !scorecardData.playerBAbsent" class="flex items-center gap-2 mt-1">
            <label class="flex items-center gap-1 cursor-pointer text-xs">
              <span class="text-muted-foreground">Absent</span>
              <input 
                type="checkbox" 
                [(ngModel)]="scorecardData.playerBAbsent"
                (change)="onPlayerAbsenceChange('B')"
                class="w-3 h-3 text-primary bg-background border-border rounded">
            </label>
          </div>
          <div *ngIf="isEditMode() && scorecardData.playerBAbsent" class="flex items-center gap-3 mt-1 text-xs">
            <label class="flex items-center gap-1 cursor-pointer">
              <span class="text-muted-foreground">No Notice (0pts)</span>
              <input 
                type="radio" 
                name="playerBAbsenceType"
                [value]="false"
                [(ngModel)]="scorecardData.playerBAbsentWithNotice"
                class="w-3 h-3 text-primary bg-background border-border">
            </label>
            <label class="flex items-center gap-1 cursor-pointer">
              <span class="text-muted-foreground">Notice (4pts)</span>
              <input 
                type="radio" 
                name="playerBAbsenceType"
                [value]="true"
                [(ngModel)]="scorecardData.playerBAbsentWithNotice"
                class="w-3 h-3 text-primary bg-background border-border">
            </label>
            <label class="flex items-center gap-1 cursor-pointer">
              <span class="text-foreground">Absent</span>
              <input 
                type="checkbox" 
                [(ngModel)]="scorecardData.playerBAbsent"
                (change)="onPlayerAbsenceChange('B')"
                class="w-3 h-3 text-primary bg-background border-border rounded">
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Compact Scorecard Table -->
    <div class="flex-1 overflow-auto">
      <table class="w-full text-xs border-collapse bg-background font-mono">
        <!-- Course Info Header -->
        <thead>
          <!-- Hole Numbers Row -->
          <tr class="bg-muted/30">
            <td class="border border-border p-1 text-center font-bold text-foreground bg-muted/50 min-w-[80px] sm:p-2">Player</td>
            <td class="border border-border p-1 text-center font-bold text-muted-foreground min-w-[24px] sm:min-w-[32px] sm:p-2" *ngFor="let hole of course.holes">
              {{ hole.number }}
            </td>
            <td class="border border-border p-1 text-center font-bold text-foreground bg-muted/50 sm:p-2">Total</td>
          </tr>
          
          <!-- Par Row -->
          <tr class="bg-muted/30">
            <td class="border border-border p-1 text-center font-bold text-foreground bg-muted/50 sm:p-2">Par</td>
            <td class="border border-border p-1 text-center font-bold text-muted-foreground sm:p-2" *ngFor="let hole of course.holes">
              {{ hole.par }}
            </td>
            <td class="text-lg border border-border p-1 text-center font-bold text-foreground bg-muted/50 sm:p-2">{{ getTotalPar() }}</td>
          </tr>
          
          <!-- Handicap Row -->
          <tr class="bg-muted/30">
            <td class="border border-border p-1 text-center font-bold text-foreground bg-muted/50 sm:p-2">HCP</td>
            <td class="border border-border p-1 text-center text-xs text-muted-foreground sm:p-2" *ngFor="let hole of course.holes">
              {{ hole.handicap }}
            </td>
            <td class="border border-border p-1 text-center font-bold text-foreground bg-muted/50 sm:p-2"></td>
          </tr>
        </thead>
        
        <!-- Player Scores -->
        <tbody>
          <!-- Player A Row -->
          <tr class="bg-muted/40">
            <td class="border border-border p-1 font-medium text-foreground bg-muted/50 sm:p-2 text-center">
              <span class="font-bold text-base">{{ scorecardData.playerAName }}</span>
            </td>
            <td class="border border-border relative h-10 p-0 m-0 sm:h-12" *ngFor="let hole of course.holes; let i = index">
              <!-- Compact Score Input/Display -->
              <input 
                type="number"
                [ngModel]="getPlayerScore(i, 'A')"
                (ngModelChange)="setPlayerScore(i, 'A', $event)"
                [class]="getScoreClass(getPlayerScore(i, 'A'), hole.par)"
                class="absolute inset-0 w-full h-full text-center border-0 bg-transparent text-foreground focus:bg-primary/10 focus:ring-2 focus:ring-primary/20 focus:outline-none leading-none placeholder:text-xl placeholder:font-bold placeholder:text-muted-foreground/50 hover:bg-muted/50 transition-colors"
                [readonly]="isViewMode()"
                [tabindex]="isViewMode() ? -1 : 0"
                min="1"
                max="10"
                placeholder="-"
                [attr.aria-label]="'Player A score for hole ' + hole.number">
              
              <!-- Compact Net Score Display -->
              <div class="absolute bottom-0 left-0 right-0 text-xs text-muted-foreground text-center leading-none pointer-events-none">
                {{ getNetScore(i, 'A') }}
              </div>
              
              <!-- Compact Hole Winner Indicator -->
              <div class="absolute top-0 right-0 pointer-events-none" *ngIf="getHoleWinner(i)">
                <div class="w-2 h-2 rounded-full"
                     [class.bg-green-500]="getHoleWinner(i) === 'playerA'"
                     [class.bg-yellow-500]="getHoleWinner(i) === 'tie'"
                     [class.bg-red-500]="getHoleWinner(i) === 'playerB'">
                </div>
              </div>
            </td>
            <td class="border border-border p-1 text-center font-bold text-foreground bg-muted/50 sm:p-2">
              {{ scorecardData.playerATotalScore || 0 }}
            </td>
          </tr>
          
          <!-- Player B Row -->
          <tr class="bg-muted/60">
            <td class="border border-border p-1 font-medium text-foreground bg-muted/50 sm:p-2 text-center">
              <span class="font-bold text-base">{{ scorecardData.playerBName }}</span>
            </td>
            <td class="border border-border relative h-10 p-0 m-0 sm:h-12" *ngFor="let hole of course.holes; let i = index">
              <!-- Compact Score Input/Display -->
              <input 
                type="number"
                [ngModel]="getPlayerScore(i, 'B')"
                (ngModelChange)="setPlayerScore(i, 'B', $event)"
                [class]="getScoreClass(getPlayerScore(i, 'B'), hole.par)"
                class="absolute inset-0 w-full h-full text-center border-0 bg-transparent text-foreground focus:bg-primary/10 focus:ring-2 focus:ring-primary/20 focus:outline-none leading-none placeholder:text-xl placeholder:font-bold placeholder:text-muted-foreground/50 hover:bg-muted/50 transition-colors"
                [readonly]="isViewMode()"
                [tabindex]="isViewMode() ? -1 : 0"
                min="1"
                max="10"
                placeholder="-"
                [attr.aria-label]="'Player B score for hole ' + hole.number">
              
              <!-- Compact Net Score Display -->
              <div class="absolute bottom-0 left-0 right-0 text-xs text-muted-foreground text-center leading-none pointer-events-none">
                {{ getNetScore(i, 'B') }}
              </div>
            </td>
            <td class="border border-border p-1 text-center font-bold text-foreground bg-muted/50 sm:p-2">
              {{ scorecardData.playerBTotalScore || 0 }}
            </td>
          </tr>
          
          <!-- Match Points Row -->
          <tr class="bg-primary/10">
            <td class="border border-border p-1 text-center font-bold text-foreground bg-primary/20 sm:p-2">Match Pts</td>
            <td class="border border-border p-1 text-center sm:p-2" *ngFor="let hole of course.holes; let i = index">
              <div class="grid grid-cols-2 gap-1 text-xs font-bold">
                <div class="text-center" 
                     [class.text-green-600]="getMatchPoints(i, 'A') === 2"
                     [class.text-yellow-600]="getMatchPoints(i, 'A') === 1"
                     [class.text-red-600]="getMatchPoints(i, 'A') === 0">
                  {{ getMatchPoints(i, 'A') }}
                </div>
                <div class="text-center"
                     [class.text-green-600]="getMatchPoints(i, 'B') === 2"
                     [class.text-yellow-600]="getMatchPoints(i, 'B') === 1"
                     [class.text-red-600]="getMatchPoints(i, 'B') === 0">
                  {{ getMatchPoints(i, 'B') }}
                </div>
              </div>
            </td>
            <td class="border border-border p-1 text-center sm:p-2">
              <div class="grid grid-cols-2 gap-1 text-xs font-bold">
                <div class="text-primary">{{ scorecardData.playerAHolePoints || 0 }}</div>
                <div class="text-primary">{{ scorecardData.playerBHolePoints || 0 }}</div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Enhanced Footer with Detailed Results -->
    <div class="bg-muted/20 border-t border-border p-3 flex-shrink-0 sm:p-4">
      <div class="grid grid-cols-3 gap-4 text-sm">
        <!-- Player A Score Summary -->
        <div class="text-left space-y-1">
          <div class="font-bold text-blue-600 truncate">{{ scorecardData.playerAName }}</div>
          <div class="text-xs text-muted-foreground">
            Gross: <span class="font-bold text-blue-600">{{ scorecardData.playerATotalScore || 0 }}</span>
          </div>
          <div class="text-xs text-muted-foreground">
            Match: <span class="font-bold text-primary">{{ scorecardData.playerAMatchPoints || 0 }}/20</span>
            <span *ngIf="scorecardData.playerAMatchWin" class="ml-1 text-green-600 font-bold">🏆+2</span>
          </div>
          <div class="text-xs text-muted-foreground">
            Holes: {{ scorecardData.playerAHolePoints || 0 }}
            <span *ngIf="scorecardData.playerAMatchWin" class="text-green-600">+ 2 bonus</span>
          </div>
        </div>
        
        <!-- Match Results Center -->
        <div class="text-center space-y-1">
          <div class="font-bold text-foreground">{{ getMatchPlayResult() }}</div>
          <div class="text-xs text-muted-foreground">Match Play</div>
          <div class="text-xs text-muted-foreground">{{ getMatchPlayScore() }}</div>
          <div *ngIf="scorecardData.playerAMatchWin || scorecardData.playerBMatchWin" class="text-xs text-green-600 font-medium">
            +2 Match Winner Bonus
          </div>
        </div>
        
        <!-- Player B Score Summary -->
        <div class="text-right space-y-1">
          <div class="font-bold text-red-600 truncate">{{ scorecardData.playerBName }}</div>
          <div class="text-xs text-muted-foreground">
            Gross: <span class="font-bold text-red-600">{{ scorecardData.playerBTotalScore || 0 }}</span>
          </div>
          <div class="text-xs text-muted-foreground">
            Match: <span class="font-bold text-primary">{{ scorecardData.playerBMatchPoints || 0 }}/20</span>
            <span *ngIf="scorecardData.playerBMatchWin" class="ml-1 text-green-600 font-bold">🏆+2</span>
          </div>
          <div class="text-xs text-muted-foreground">
            Holes: {{ scorecardData.playerBHolePoints || 0 }}
            <span *ngIf="scorecardData.playerBMatchWin" class="text-green-600">+ 2 bonus</span>
          </div>
        </div>
      </div>
      
      <!-- Stroke Play Summary -->
      <div class="mt-3 pt-2 border-t border-border text-center">
        <div class="text-xs text-muted-foreground">
          Stroke Play: <span class="font-medium">{{ getMatchResult() }} {{ getScoreDifference() }}</span>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div *ngIf="isEditMode()" class="bg-muted border-t border-border p-3 flex justify-end gap-4 flex-shrink-0 sm:p-4">
      <button 
        (click)="onClose()"
        class="px-4 py-2 text-sm border dark:bg-gray-600 text-primary-foreground dark:text-white border-border rounded-md hover:bg-muted/50 transition-colors">
        Cancel
      </button>
      <button 
        (click)="onSave()"
        [disabled]="isLoading || !isValidScorecard()"
        class="px-4 py-2 text-sm bg-primary text-primary-foreground dark:text-white rounded-md hover:bg-primary/90 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
        {{ isLoading ? 'Saving...' : 'Save' }}
      </button>
    </div>

    <!-- Loading Overlay -->
    <div *ngIf="isLoading" class="absolute inset-0 bg-background/80 flex items-center justify-center">
      <div class="text-center">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-2"></div>
        <div class="text-sm text-muted-foreground">Loading scorecard...</div>
      </div>
    </div>

    <!-- Error Display for View Mode -->
    <div *ngIf="error && isViewMode()" class="bg-destructive/10 border border-destructive/20 rounded-md p-3 m-3">
      <div class="text-sm text-destructive">{{ error }}</div>
    </div>

    <!-- Save Error Display -->
    <div *ngIf="saveError" class="bg-destructive/10 border border-destructive/20 rounded-md p-3 m-3">
      <div class="text-sm text-destructive">{{ saveError }}</div>
    </div>
  </div>
</div>
